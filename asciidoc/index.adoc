= IdentityAccess API Documentation
:doctype: book
:icons: font
:source-highlighter: highlightjs
:toc: left
:imagesDir: /images/
:toclevels: 1
:sectlinks:

[introduction]
= Introduction

[.lead]
This is the client documentation for using the *Identity and Access API*.

:numbered:

= API Overview

== Rules

We try to never break our APIs (especially as soon as they are "public"). Clients have to tolerate the addition of new fields, also the
ordering of the fields may change in the future. Not all described fields appear in every context. If we have to change our API (in case of
changing the hole structure or eliminating some Endpoints), we add a new version of the API. Clients of old versions are supported as long
as possible.

== Environments

The central endpoint for all our API's is the root environment URL which points to our `api-gateway`. Concrete endpoints for the provided business functionality is further
distinguished by the path.

|===
|Name |Root URL |Description

|secondo
|secondo.dev.myscotty.com
|The `secondo` environment is the second staging environment after our development environment. It can be treated as more stable with
announced deployments.

|production
|api.myscotty.com
|The `production` environment is the most stable environment and its the environment for the enduser of our applications.
|===

IMPORTANT: Don't use any other endpoint to integrate the API. The composition of our distributed system is heavily based on Reverse Proxies,
so there are more Endpoints to the same Resource. In the future we might block request to other resources. So please ensure to use only
the endpoint stated above.

= Mobile Deeplink API

|===
|Deeplink |Flow |Description |Next action?

|[[activation-deeplink]]mobikee://*activation*?secret=<SHARED_ECRET>&email=<EMAIL>&auth_type=<AUTH_TYPE
|Account activation
|Deeplinked after user has clicked on the Activation Link (within Mail-App on mobile phone)
|Activate account by using POST .../activation

|[[signup-deeplink]]mobikee://*signup*?payload=<SIGNUP_PAYLOAD>
|Single-Sign-On
|Deeplinked after a new account registration attempt via a Single-Sign-On Provider
|Register account by using POST .../accounts without any password

|[[auth-deeplink]]mobikee://*auth*?access_token=<ACCESS_TOKEN>&refresh_token=<REFRESH_TOKEN>
|Single-Sign-On
|Deeplinked after successful login via a Single-Sign-On Provider
|Proceed as a authenticated user

|[[doi-deeplink]]mobikee://*doi*?email=<EMAIL>
|Single-Sign-On
|Deeplinked after unsuccessful login attempt via a Single-Sign-On Provider with a non-activated account, account activation pending
|Resend Activation-Mail or guide user to Mail App

|===

= The REST API

== Authentication

A user authenticates itself either with a username/password (password-based) combination or using a 3rd party login like facebook or google (single-sign-on-based).

===  Token credentials: operating principles
- Each request to a secured endpoint requires an attached access token for the authentication process.
- An access token consists of a signed JWT footnote:[https://tools.ietf.org/html/rfc7519]
- The expiration of an access token can be determined by interpreting the `expires_in` field.
- If the access token expires, a service endpoint will respond with a 403 status.
- For the password-based authentication flow, a refresh_token will only be created, if the `remember_me` flag is  set to true
- An refresh token consists of a UUID footnote:[https://tools.ietf.org/html/rfc4122]
- As long as the refresh token is valid (60 days), the user can refresh the token credentials using this refresh token.
- With each _refresh_ operation both, a new access token as well as a new refresh token will be created.
- If a password-based authentication is performed, the refresh token will be renewed and the old one will be revoked.
- If the refresh token expires, the refresh endpoint will respond with a 403 status.
- Only the latest created refresh_token is valid for refresh requests as others will be revoked
- The refresh endpoint is a dedicated REST endpoint which accepts Content-type `application/x-www-form-urlencoded` and which requires a `refresh_token=<refresh_token>` payload.

Summary: A user should only be forced to re-login if no refresh operation is performed for 60 days.

== Flows with Examples

=== Registration & Authentication

*Only activated-accountâ€™s can be authenticated!*

Abstract flow is as follows:

image::flowOverview.png[flow-overview,align=center]
// https://www.websequencediagrams.com/?lz=cGFydGljaXBhbnQgVXNlcgoABQxBcHAKVXNlci0-QXBwOkRpc2NvdmVycyBtb2Jpa2VlABELTmF2aWdhdGVzIHRvIFxuIkxvZyBpbiBvciBjcmVhdGUgYSBuZXcgYWNjb3VudCIKQXBwAE8GU2hvdyBsb2dpbi0gb3Igc2lnbnVwIGZvcm0KCmFsdCBjaG9vc2VzICdTaWduIHVwIHdpdGggZW1haWwnCiAgICBub3RlIG92ZXIAgToFLEFwcDpzZWUgUGFzc3dvcmQtYmFzZWQgcmVnaXN0cmF0aW9uIGZsb3cKZWxzZSB1c2VzAHgGAE0LACwrYXV0aGVudGljADkgRmFjZWJvb2sgb3IgR29vZ2xlAIEhHFNpbmdsZS1TaWduLU9uAIE8BwCBMAZuZAo&s=earth

==== Password-based [[username-password-auth]]

1) non-existing account _-(registration)->_

2) non-activated account _-(activation)->_

3) activated-account _-(authentication)->_

4) access token

===== Registration

====== Request

include::{snippets}/account-resource-post-accounts/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-accounts/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/account-resource-post-accounts/http-response.adoc[leveloffset=+1]

===== Activation

====== Request

WARNING: The field _shared_secret_ for the activation is part of the deeplink (<<activation-deeplink>>)

include::{snippets}/account-resource-post-activation/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-activation/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/account-resource-post-activation/http-response.adoc[leveloffset=+1]

===== Authentication

====== Request
include::{snippets}/account-resource-post-authentication/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-authentication/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/account-resource-post-authentication/response-headers.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-authentication/http-response.adoc[leveloffset=+1]

==== Social-webflow-based - Facebook / Google [[social-oauth]]

Abstract flow is as follows:

1) non-existing account _-(registration)->_

2) non-activated account _-(activation)->_

3) activated-account _-(authentication)->_

4) access token

image::singleSignOnFlow.png[sso-flow,align=center]
// https://www.websequencediagrams.com/?lz=VXNlci0-K0FwcDpsb2dpbiB3aXRoIGZhY2Vib29rCkFwcC0-KitXZWJWaWV3Om9wZW4gL2lkZW50aXR5YWNjZXNzL2FwaS92MS9hdXRoZW50aWNhdGlvbi8AOglvcHQgZGVmYXVsdCBzb2NpYWwtAGUFLWZsb3cKICAgIABXBy0-QmFja2VuZDoAEQUABgctLT4AdggAHw5GAIEdBwAoBgAGCAAkCyBzaG93AIFCCSBhdXRoXG4gZGlhbG9nIChvcHRpb25hbCkAfgUAggEGAIFfCACBQAtlICsANQVvcml6ZSBhcHBcbgAsDwBxIACBKBcAgWQIc2VuZACBFwUgY29kZSBhbmQgc3RhdGUAgXcNAIFjCmV4Y2hhbmdlACkKAIFvEACCMBUAgiQKZmV0Y2ggdXNlciBkYXRhIGZyb20gZ3JhcGggYXBpADQZZW5kCgCBBQkAgyAIY2hlY2sgYWNjb3VudHMgZm9yAINbBwBaBmlkCm5vdGUgb3ZlcgCDRwg6IE5vbi1leGlzdGluZwA0CABSCQCDYwpTZW5kIHJlZGlyZWN0IHRvXG5tb2Jpa2VlOi8vc2lnbnVwP3BheWxvYWQ9PFNJR05VUF9QQVlMT0FEPlxuKGJhc2U2NCBlbmNvZGVkIEpXVCkKAIReCUFwcDp0cmlnZ2VyIElOVEVOVCAKZGVzdHJveQCFBAgAhXMGQXBwOnNhdmUgdW5tb2RpZmllZCAAWxIrIABnB2RlAIM-BQCAfxAAQgpwZXJzaXN0IGZpZWxkcyB0byBzZXNzaW9uIHN0b3JhZ2Vcbihmb3IgbGF0ZXIgdXNhZ2UhKQoAgj8GcmlnaHQgb2YgQXBwOiBORVchCmFsdCBlbWFpbCBkb2VzIE5PVCBhbHJlYWR5IACCXAUgaW4AexIgICAgAIFTCgCGHQVvcm0Ah3EGdXNlcm5hbWUAgRsGAIYOC0FwcDphZGQAGAkADA9zdWJtaXQAhB8FAIgsBgCHQQhQT1NUAIgXGQCELwhcbgBvDisAglMcAIRzEkNyZWF0ZQCEQQkAhF4UZXcgbm9uLWFjdGl2YXRlZACEZhE-RU1haWwAhwYGRE9JIG1haWwKAIJbBUxvZ2dlZCBvdXQsAIVhCCBub3QgAEMJLCBkb3VibGUtb3B0LWluABEIaW9uIACJWAkAil8GAF4GY2xpY2sAYAVsaW5rAIl7BQB4BQCJYgVBcHAAil4GYnJvd3NlcgCLCAZET0kgVVJMAIokCACLDwUAJgcAhgocAIEACj9zZWNyZXQ9PFNFQ1JFVD5cbiYAhDMFPTxFTUFJTD4mYXV0aF90eXBlPTxBVVRIX1RZUEUAhCUGAGgIAIYiEgCEQAoAg0gmAIIPCACDaAcAgQQIAIUDDgCITAYAdRAAjQAGAIx3DgCMZBJlLwCBLRAAiHQKVXNlciwAjT8HLEFwcCwAjGQHLACMPQkgc2VlICIAjRAZIgCNByMAiW0rAIEQDgCKEwlFAIoOCgCFGxAAjX0WAIoWECAAg3QNdXRoPwCPHwZfdG9rZW49PEFDQ0VTU19UT0tFTj5cbiZyZWZyZXNoABcIUkVGUkVTSAAZBwCPDw4AiiIUICAgIACKKhAAiFQNAIlqCABrDiAmIFxuAF4PAIl7EwCDOgoAiXQJAIw8CkVXIQCEahh1c2VyLXByb2ZpbGUAkRYIAAgHAIhlBwCLAgcAizwTLQCLFgYAihQTIkEAh3gHAIg-CSIgc2NyZWVuCmVsc2UAiAgiIChtYXliZSBkb2ktAIsxBmxvc3Q_AJB1DACLVwUAknQUAIVuGACSXS4AhFaBPgCLLRYAkhoNAJAnFgCQLwpkb2k_AIltDQCFF0wAikYGAI88GgCPSwUgaW4gcmUAk3AFAIQ3BgCUegYAhFQXbXVzdCBiZQCERywAjVwJAIIvgigAiUCBKwCPcggAmgQKAIkUgWkAkwEHaW4AimsKbmQ&s=earth

===== Registration / Non-existing account

====== 1. Request
include::{snippets}/oauth2-get-authentication-facebook-non-existing/curl-request.adoc[leveloffset=+1]
include::{snippets}/oauth2-get-authentication-facebook-non-existing/http-request.adoc[leveloffset=+1]

====== 1. Response
include::{snippets}/oauth2-get-authentication-facebook-non-existing/http-response.adoc[leveloffset=+1]

====== 2. Request

WARNING: The field _auth_id_jwt_ (= <SIGNUP_PAYLOAD>) for the registration is part of the deeplink (<<signup-deeplink>>)

include::{snippets}/account-resource-post-accounts-authid/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-accounts-authid/http-request.adoc[leveloffset=+1]

====== 2. Response
include::{snippets}/account-resource-post-accounts-authid/http-response.adoc[leveloffset=+1]

===== Activation

====== Request

WARNING: The field _shared_secret_ for the activation is part of the deeplink (<<activation-deeplink>>)

include::{snippets}/account-resource-post-activation/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-activation/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/account-resource-post-activation/http-response.adoc[leveloffset=+1]

===== Authentication / Non-activated account

WARNING: This authentication attempt fails because the account is not activated.

====== Request
include::{snippets}/oauth2-get-authentication-facebook-non-activated/curl-request.adoc[leveloffset=+1]
include::{snippets}/oauth2-get-authentication-facebook-non-activated/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/oauth2-get-authentication-facebook-non-activated/http-response.adoc[leveloffset=+1]

===== Authentication / Activated account

====== Request
include::{snippets}/oauth2-get-authentication-facebook-activated/curl-request.adoc[leveloffset=+1]
include::{snippets}/oauth2-get-authentication-facebook-activated/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/oauth2-get-authentication-facebook-activated/http-response.adoc[leveloffset=+1]

==== Social-token-based - Facebook / Google [[social-oauth]]
The user expects that a social login doesn't require further actions. He needs to click only "Login with facebook/google".

Possible states how the account activation/email-verification can look like after certain processes:

|===
|Type |active |condition |email verified |description |send DOI

|E-mail/PW
|false
|
|false
|Email/Password registration
|true

|Facebook
|true
|
|false
|Facebook, email is not verified
|true

|Google
|true
|requestEmail=socialEmail
|true
|Google email is verified
|false

|Google
|true
|requestEmail!=socialEmail
|true
|The email does not match the verified email at google. The requestEmail is taken from the DOI
|true

|Google
|true
|
|false
|Google account is available, but with external email e.g. example@de.bosch.com
|true

|===


Abstract flow is as follows:

1) non-existing account _-(social registration)->_

2) access token

image::socialTokenFlow.png[sso-flow,align=center]

===== Registration

====== Request
include::{snippets}/account-resource-post-accounts-social/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-accounts-social/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/account-resource-post-accounts-social/http-response.adoc[leveloffset=+1]

===== Authentication

====== Request
include::{snippets}/account-resource-post-activation-social/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-activation-social/http-request.adoc[leveloffset=+1]

====== Response
include::{snippets}/account-resource-post-activation-social/http-response.adoc[leveloffset=+1]

=== Refresh authentication

==== Request
include::{snippets}/account-resource-post-authentication-refresh/curl-request.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-authentication-refresh/http-request.adoc[leveloffset=+1]

==== Response
include::{snippets}/account-resource-post-authentication-refresh/response-headers.adoc[leveloffset=+1]
include::{snippets}/account-resource-post-authentication-refresh/http-response.adoc[leveloffset=+1]

include::{snippets}/overview.adoc[leveloffset=+1]
include::{snippets}/paths.adoc[leveloffset=+1]
include::{snippets}/definitions.adoc[leveloffset=+1]

include::error.adoc[]

[appendix]
= Frequently Asked Questions

[NOTE]
====
.Any questions?
Please contact us.
====
